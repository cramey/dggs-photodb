<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
	PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
	"http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="gov.alaska.dggs.photodb.Image">
	<sql id="getBy">
		SELECT image_id, filename, image_date,
			ST_AsText(ST_Transform(geog::GEOMETRY, 3857)) AS wkt,
			description, metadata::text
	</sql>


	<select id="getByID" resultSetType="FORWARD_ONLY" parameterType="int" resultMap="ImageMap">
		<include refid="getBy" />
		FROM image
		WHERE image_id = #{id}
	</select>


	<select id="getFromID" resultSetType="FORWARD_ONLY" parameterType="Map" resultMap="ImageMap">
		<include refid="getBy" />
		FROM image
		WHERE 
		<choose>
			<when test="back == true">
				image_id &lt; #{id}
			</when>
			<otherwise>
				image_id &gt; #{id}
			</otherwise>
		</choose>
		<choose>
			<when test="emptydesc == true">
				AND description IS NULL
			</when>
			<when test="emptydesc == false">
				AND description IS NOT NULL
			</when>
		</choose>
		<choose>
			<when test="back == true">
				ORDER BY image_id DESC
			</when>
			<otherwise>
				ORDER BY image_id ASC
			</otherwise>
		</choose>
		LIMIT ${show}
	</select>


	<resultMap id="ImageMap" type="Image">
		<id property="id" column="image_id" />

		<result property="filename" column="filename" />
		<result property="credit" column="credit" />
		<result property="description" column="description" />
		<result property="date" column="image_date" />
		<result property="metadata" column="metadata" />
		<result property="wkt" column="wkt" />

		<collection property="tags" column="image_id" ofType="Tag" select="gov.alaska.dggs.photodb.Tag.getByImageID" />
	</resultMap>
</mapper>
