<!DOCTYPE html>
<html lang="en">
	<head>
		<title>Photo Database</title>
		<link rel="stylesheet" href="js/leaflet-0.7.3.css" />
		<link rel="stylesheet" href="js/L.Control.MousePosition.css" />
		<style>
			#detailcontainer { display: none; }
			#detailcontainer label { display: block; }
			#detail { margin: 20px 0px 0px 15px; }
			#detail th, #detail td { text-align: left; vertical-align: top; }
			#results { text-align: center; }
			#results img { margin: 4px 8px; vertical-align: text-top; cursor: pointer; }
			#btn-prev, #page-next { margin: 4px 8px; }
			#btn-prev { float: left; }
			#btn-next { float: right; }
			#btn-save { float: right; }
			#map { float: right; height: 550px; width: 50%; }
			#err { text-align: right; color: red; }
			.leaflet-popup { opacity: 0.3 !important; }
			.leaflet-popup:hover { opacity: 1 !important; }
		</style>
		<script src="js/jquery-2.1.3.min.js"></script>
		<script src="js/leaflet-0.7.3.min.js"></script>
		<script src="js/L.Control.MousePosition.js"></script>
		<script>
			var map, marker = null;
			var last = [0,0];

			$(function(){
				$('#btn-search').click(function(){
					last = [0,0];
					$(document.activeElement).blur();
					search(false);
				});

				$('#emptydesc').change(function(){
					$('#btn-search').click();
				});

				$('#btn-prev').click(function(){ search(true); });
				$('#btn-next').click(function(){ search(false); });

				// Search by specified set if in the hash
				if(location.hash.length){
					last[0] = last[1] = Number(location.hash.substring(1));
				}
				search(false);

				$('#btn-return').click(function(){
					if($('#detailcontainer').is(':visible')){
						$('#detailcontainer').hide();
						$('#controlcontainer, #resultscontainer').show();
						location.hash = JSON.stringify(last);
					}
				});
				$('#btn-save').click(save);
				$('#btn-delete').click(remove);

				$('body').keyup(function(e){
					var vis = $('#detailcontainer').is(':visible');
					// Escape
					if(e.which == 27 && vis) $('#btn-return').click();

					if(!vis && document.activeElement == document.body){
						// Left arrow
						if(e.which == 37) $('#btn-prev').click();
						// Right arroe
						else if(e.which == 39) $('#btn-next').click();
						// 1-9
						else if(e.which >= 49 && e.which <= 57){
							var i = (e.which - 49);
							var imgs = $('#results img');
							if(i < imgs.length) imgs.get(i).click();
						}
					}
				});

				// Collect our baselayers
				var baselayers = {
					'Open Street Maps': new L.TileLayer(
						'http://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',
						{ minZoom: 3, maxZoom: 16 }
					),
					'MapQuest Open Aerial': new L.TileLayer(
						'http://otile4.mqcdn.com/tiles/1.0.0/sat/{z}/{x}/{y}.png',
						{ minZoom: 3, maxZoom: 11 }
					)
				};

				// Build the map, it expects baselayers as an array
				map = L.map('map', {
					attributionControl: false,
					layers: [baselayers['Open Street Maps']]
				});

				// Initialize lon/lat control display on map
				L.control.mousePosition().addTo(map);
				// Initialize layer switcher control
				L.control.layers(baselayers, []).addTo(map);

				// Add a marker if there isn't one, on click
				map.on('click', function(evt){
					if(marker == null){
						marker = L.marker(
							evt.latlng,
							{ keyboard: false, draggable: true }
						).bindPopup(
							'<img src="thumbnail/' + $('#id').val() + '"/>',
							{ autoPanPaddingTopLeft: [40, 10] }
						).addTo(map);
					}
				});
			});


			function search(back)
			{
				$.ajax({
					url: 'list.json', dataType: 'json',
					data: {
						'id': back ? last[0] : last[1],
						'back': back,
						'show': $('#show').val(),
						'emptydesc': $('#emptydesc').val()
					},
					success: function(json){
						if(json.length){
							var results = $('#results').empty().get(0);

							var render = function(im){
								$(document.createElement('img'))
									.attr('src', 'thumbnail/' + im['ID'])
									.attr('id', 'img-' + im['ID'])
									.prop('data', im)
									.click(detail)
									.appendTo(results);
							};

							if(back){
								for(var i=json.length; i--;) render(json[i]);

								last[0] = json[json.length - 1]['ID'];
								last[1] = json[0]['ID'];
							} else {
								for(var i=0; i < json.length; i++) render(json[i]);

								last[0] = json[0]['ID'];
								last[1] = json[json.length - 1]['ID'];
							}
							location.hash = (last[0] - 1);

							if(!$('#detailcontainer').is(':visible')){
								$('#resultscontainer').show();
							}
						}
					}
				});
			}


			function detail()
			{
				$('#controlcontainer, #resultscontainer').hide();
				$('#detailcontainer').show();
				$('#date').focus();

				map.closePopup();
				if(marker != null){
					map.removeLayer(marker);
					marker = null;
				}


				$('#filename').html(
					'<a target="_blank" href="image/' + this.data['ID'] + '">' +
					this.data['filename'] + '</a>'
				);

				$('#id').val(this.data['ID']);
				$('#date').val('date' in this.data ? this.data['date'] : '');
				$('#credit').val('credit' in this.data ? this.data.credit : '');
				$('#description').val(
					'description' in this.data ? this.data.description : ''
				);

				map.setView([64.843611, -147.723056], 3);
				if('geoJSON' in this.data){
					var geojson = JSON.parse(this.data.geoJSON);

					marker = L.marker(
						[geojson.coordinates[1], geojson.coordinates[0]],
						{ keyboard: false, draggable: true }
					).bindPopup(
						'<img src="thumbnail/' + this.data['ID'] + '"/>',
						{
							autoPanPaddingTopLeft: [40, 10],
							autoPanPaddingBottomRight: [55, 10]
						}
					).addTo(map).openPopup();
				}
			}


			function save()
			{
				$('#err').empty();

				var obj = { 'ID': $('#id').val() };

				var description = $('#description').val();
				if(description.length) obj['description'] = description;

				var credit = $('#credit').val();
				if(credit.length) obj['credit'] = credit;

				var dt = $('#date').val();
				if(dt.length) obj['date'] = dt;

				if(marker != null){
					obj['geojson'] = JSON.stringify(
						marker.toGeoJSON()['geometry']
					);
				}

				$('#btn-save').prop('disabled', true).text('Saving.. ');

				$.ajax({
					url: 'image.json', type: 'POST',
					data: obj, dataType: 'json', 
					success: function(json){
						if('success' in json && json['success']){
							$('#btn-save').prop('disabled', false).text('Save Detail');
							// Update saved image object with new data
							var img = $('#img-' + obj['ID']);
							img.prop('data', $.extend(img.prop('data'), obj));
						}
					},
					error: function(xhr){
						$('#btn-save').prop('disabled', false).text('Save Detail');
						$('#err').text('Error saving: ' + xhr.responseText);
					}
				});
			}

			function remove()
			{
				var msg = "Are you sure you want to delete this photo?\n" +
					"This cannot be undone.";
				if(confirm(msg)){
					var id = $('#id').val();
					$.ajax({
						url: 'image.json', type: 'POST', dataType: 'json',
						data: { 'action': 'delete', 'ID': id },
						success: function(json){
							if('success' in json && json['success']){
								// Hide image on search
								$('#img-' + id).css(
									{'opacity': 0.1, 'cursor': 'auto'}
								).unbind('click');
								// Return to search
								$('#btn-return').click();
							}
						}
					});
				}
			}
		</script>
	</head>
	<body load="init()">
		<fieldset id="controlcontainer">
			<legend>Search</legend>
			<button title="Previous Page - Left Arrow" id="btn-prev">Previous Page</button>
			<button title="Next page - Right Arrow" id="btn-next">Next Page</button>

			<label for="emptydesc">Description: </label>
			<select name="emptydesc" id="emptydesc">
				<option value="">Any</option>
				<option value="true" selected="selected">Only Empty</option>
				<option value="false">Only Filled</option>
			</select>

			<label for="show">Showing: </label>
			<input type="text" size="4" name="show" id="show" value="6" />

			<button id="btn-search">Search</button>
		</fieldset>

		<fieldset id="resultscontainer">
			<legend>Results</legend>
			<div id="results"></div>
		</fieldset>

		<fieldset id="detailcontainer">
			<legend>Detail</legend>

			<div id="map"></div>

			<button title="Return to Search - Escape" id="btn-return">Return to Search</button>

			<input type="hidden" name="id" id="id" />

			<table id="detail">
				<tbody>
					<tr>
						<th>Filename:</th>
						<td id="filename"></td>
					</tr>
					<tr>
						<th>Date:</th>
						<td>
							<input type="text" name="date" id="date" size="9" />
						</td>
					</tr>
					<tr>
						<th>Credit:</th>
						<td>
							<textarea name="credit" id="credit" cols="30" rows="2"></textarea>
						</td>
					</tr>
					<tr>
						<th>Description:</th>
						<td>
							<textarea name="description" id="description" cols="35" rows="5"></textarea>
						</td>
					</tr>
					<tr><td colspan="2">&nbsp;</td></tr>
					<tr>
						<td>&nbsp;</td>
						<td>
							<button accesskey="d" id="btn-delete"><u>D</u>elete Photo</button>
							<button accesskey="s" id="btn-save"><u>S</u>ave Detail</button>
						</td>
					</tr>
					<tr><td colspan="2" id="err"></td></tr>
				</tbody>
			</table>
		</fieldset>
	</body>
</html>
