<!DOCTYPE html>
<html lang="en">
	<head>
		<title>Photo Database</title>
		<link rel="stylesheet" href="js/leaflet-0.7.3.css" />
		<style>
			#detailcontainer { display: none; }
			#detailcontainer label { display: block; }
			#detail { margin: 20px 0px 0px 20px; }
			#detail th, #detail td { text-align: left; vertical-align: top; }
			#results { text-align: center; }
			#results img { margin: 4px 8px; vertical-align: text-top; cursor: pointer; }
			#btn-prev, #page-next { margin: 4px 8px; }
			#btn-prev { float: left; }
			#btn-next { float: right; }
			#map { float: right; height: 300px; width: 50%; }
		</style>
		<script src="js/jquery-2.1.3.min.js"></script>
		<script src="js/leaflet-0.7.3.min.js"></script>
		<script>
			var map, layer = null;
			var last = [0,0];

			$(function(){
				$('#btn-search').click(function(){
					last = [0,0];
					search(false);
				}).click();

				$('#emptydesc').change(function(){
					$('#btn-search').click();
				});

				$('#btn-prev').click(function(){ search(true); });
				$('#btn-next').click(function(){ search(false); });
				$('#btn-return').click(function(){
					$('#detailcontainer').hide();
					$('#controlcontainer, #resultscontainer').show();
				});

				$('body').keyup(function(e){
					var vis = $('#detailcontainer').is(':visible');
					// Escape
					if(e.which == 27 && vis) $('#btn-return').click();
					// Left arrow
					else if(e.which == 37 && !vis) $('#btn-prev').click();
					// Right arroe
					else if(e.which == 39 && !vis) $('#btn-next').click();
					// 1-9
					else if(e.which >= 49 && e.which <= 57 && !vis){
						var i = (e.which - 49);
						var imgs = $('#results img');
						if(i < imgs.length) imgs.get(i).click();
					}
				});

				map = L.map('map').addLayer(new L.TileLayer(
					'http://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',
					{minZoom: 3, maxZoom: 12}
				));
			});

			function search(back)
			{
				$.ajax({
					url: 'list.json', dataType: 'json',
					data: {
						'id': back ? last[0] : last[1],
						'show': $('#show').val(),
						'emptydesc': $('#emptydesc').val(),
						'back': back
					},
					success: function(json){
						if(json.length){
							var results = $('#results').empty().get(0);

							var render = function(im){
								var img = document.createElement('img');
								img.src = 'thumbnail/' + im['ID'];
								img.data = im;
								img.onclick = detail;
								results.appendChild(img);
							};

							if(back){
								for(var i=json.length; i--;) render(json[i]);

								last[0] = json[json.length - 1]['ID'];
								last[1] = json[0]['ID'];
							} else {
								for(var i=0; i < json.length; i++) render(json[i]);

								last[0] = json[0]['ID'];
								last[1] = json[json.length - 1]['ID'];
							}

							$('#resultscontainer').show();
						}
					}
				});
			}

			function detail()
			{
				if(layer != null){
					map.removeLayer(layer);
					layer = null;
				}

				$('#controlcontainer, #resultscontainer').hide();
				$('#detailcontainer').show();

				if('geoJSON' in this.data){
					var geojson = JSON.parse(this.data['geoJSON']);
					layer = new L.geoJson(
						{'type':'Feature','geometry':geojson}
					).addTo(map);

					map.setView([64.843611, -147.723056], 3);
				}

				if('filename' in this.data){
					$('#filename').text(this.data['filename']);
				}
				if('date' in this.data){
					$('#date').val(this.data['date']);
				}
				if('credit' in this.data){
					$('#credit').val(this.data['credit']);
				}
				if('description' in this.data){
					$('#description').val(this.data['description']);
				}

				$('#date').focus();
			}
		</script>
	</head>
	<body load="init()">
		<fieldset id="controlcontainer">
			<legend>Search</legend>
			<button title="Previous Page - Left Arrow" id="btn-prev">Previous Page</button>
			<button title="Next page - Right Arrow" id="btn-next">Next Page</button>

			<label for="emptydesc">Description: </label>
			<select name="emptydesc" id="emptydesc">
				<option value="">Any</option>
				<option value="true" selected="selected">Only Empty</option>
				<option value="false">Only Filled</option>
			</select>

			<label for="show">Showing: </label>
			<input type="text" size="4" name="show" id="show" value="6" />

			<button id="btn-search">Search</button>
		</fieldset>

		<fieldset id="resultscontainer">
			<legend>Results</legend>
			<div id="results"></div>
		</fieldset>

		<fieldset id="detailcontainer">
			<legend>Detail</legend>

			<div id="map"></div>

			<button title="Return to Search - Escape" id="btn-return">Return to Search</button>

			<table id="detail">
				<tbody>
					<tr>
						<th>Filename:</th>
						<td id="filename"></td>
					</tr>
					<tr>
						<th>Date:</th>
						<td>
							<input type="text" name="date" id="date" size="9" />
						</td>
					</tr>
					<tr>
						<th>Credit:</th>
						<td>
							<textarea name="credit" id="credit" cols="30" rows="2"></textarea>
						</td>
					</tr>
					<tr>
						<th>Description:</th>
						<td>
							<textarea name="description" id="description" cols="35" rows="5"></textarea>
						</td>
					</tr>
				</tbody>
			</table>
		</fieldset>
	</body>
</html>
