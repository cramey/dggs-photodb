<!DOCTYPE html>
<html lang="en">
	<head>
		<title>Photo Database</title>
		<link rel="stylesheet" href="js/leaflet-0.7.3.css" />
		<link rel="stylesheet" href="js/L.Control.MousePosition.css" />
		<style>
			#edit-controls, #search-controls { padding: 4px 8px; }
			#edit-controls { text-align: center; }
			#detailcontainer { display: none; }
			#detailcontainer label { display: block; }
			#detail { margin: 20px 0px 0px 15px; }
			#detail th, #detail td { text-align: left; vertical-align: top; }
			#results { text-align: center; }
			#results a { margin: 4px 8px; display: inline-block; border: 2px solid transparent; }
			#results a img { vertical-align: text-top; }
			#results a.selected { background-color: blue; border: 2px solid blue; }
			#results a.selected img { opacity: 0.75; }
			#btn-prev, #page-next { margin: 4px 8px; }
			#btn-prev { float: left; }
			#btn-next { float: right; }
			#btn-save { float: right; }
			#map { float: right; height: 550px; width: 50%; }
			#err { text-align: right; color: red; }
			.leaflet-popup { opacity: 0.3 !important; }
			.leaflet-popup:hover { opacity: 1 !important; }
		</style>
		<script src="js/jquery-2.1.3.min.js"></script>
		<script src="js/leaflet-0.7.3.min.js"></script>
		<script src="js/L.Control.MousePosition.js"></script>
		<script>
			var map, marker = null;
			var last = [0,0];
			var selected = [];

			$(function(){
				$('#btn-search').click(function(){
					// Clear last query
					last = [0,0];

					/// Clear last selected
					selected = [];
					$('#edit-blurb').text('');

					$(document.activeElement).blur();
					search(false);
				});

				$('#emptydesc').change(function(){
					$('#btn-search').click();
				});

				$('#btn-prev').click(function(){ search(true); });
				$('#btn-next').click(function(){ search(false); });
				$('#btn-select').click(selectAll);
				$('#btn-edit').click(detail);

				$('#detail input[type=checkbox]').change(function(){
					var el_id = $(this).attr('id');
					$('#' + el_id.substring(0, (el_id.length - 8))).prop(
						'disabled', $(this).prop('checked')
					);
				});

				search(false);

				$('#btn-return').click(function(){
					if($('#detailcontainer').is(':visible')){
						$('#detailcontainer').hide();
						$('#controlcontainer, #resultscontainer').show();
					}
				});
				$('#btn-save').click(save);
				$('#btn-delete').click(remove);

				$('body').keyup(function(e){
					var vis = $('#detailcontainer').is(':visible');
					// Escape
					if(e.which == 27 && vis) $('#btn-return').click();

					if(!vis && document.activeElement == document.body){
						// Left arrow
						if(e.which == 37){
							$('#btn-prev').click();
						// Right arroe
						} else if(e.which == 39){
							$('#btn-next').click();
						// 1-9
						} else if(e.which >= 49 && e.which <= 57){
							var i = (e.which - 49);
							var imgs = $('#results a');
							if(i <= imgs.length) imgs.get(i).click();
						// 0
						} else if(e.which == 48){
							var imgs = $('#results a');
							if(imgs.length > 9) imgs.get(9).click();
						// 'a' - select all
						} else if(e.which == 65){
							selectAll();
						}
					}
				});

				// Collect our baselayers
				var baselayers = {
					'Open Street Maps': new L.TileLayer(
						'http://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',
						{ minZoom: 3, maxZoom: 16 }
					),
					'MapQuest Open Aerial': new L.TileLayer(
						'http://otile4.mqcdn.com/tiles/1.0.0/sat/{z}/{x}/{y}.png',
						{ minZoom: 3, maxZoom: 11 }
					)
				};

				// Build the map, it expects baselayers as an array
				map = L.map('map', {
					attributionControl: false,
					layers: [baselayers['Open Street Maps']]
				});

				// Initialize lon/lat control display on map
				L.control.mousePosition().addTo(map);
				// Initialize layer switcher control
				L.control.layers(baselayers, []).addTo(map);

				// Add a marker if there isn't one, on click
				map.on('click', function(evt){
					if(marker == null){
						marker = L.marker(
							evt.latlng,
							{ keyboard: false, draggable: true }
						).bindPopup(
							'<img src="thumbnail/' + $('#id').val() + '"/>',
							{ autoPanPaddingTopLeft: [40, 10] }
						).on('dblclick', function(evt){
							map.removeLayer(marker);
							marker = null;
						}).addTo(map);
					}
				});
			});


			function search(back)
			{
				var obj = {
					'id': (back ? last[0] : last[1]),
					'back': back
				};

				var fields = document.querySelectorAll(
					'#controlcontainer input, #controlcontainer select'
				);
				for(var i = fields.length; i--;){
					switch(fields[i].tagName){
						case 'INPUT':
							var val = fields[i].value.trim();
							if(val.length > 0) obj[fields[i].id] = val;
						break;

						case 'SELECT':
							var val = fields[i].options[fields[i].selectedIndex].value.trim();
							if(val.length > 0) obj[fields[i].id] = val;
						break;
					}
				}

				$.ajax({
					url: 'list.json', dataType: 'json', data: obj,
					success: function(json){
						if(json.length){
							var results = $('#results').empty().get(0);

							var render = function(im){
								var alt = '';
								if('credit' in im) alt += im['credit'];
								if('taken' in im){
									if(alt.length > 0) alt += ", ";
									alt += im['taken'];
								}
								if('summary' in im){
									if(alt.length > 0) alt += "\n";
									alt += im['summary'];
								}

								var a = $(document.createElement('a'))
									.attr('href', '#')
									.attr('title', alt)
									//.attr('id', 'img-' + im['ID'])
									.attr('class', selected.indexOf(im['ID']) >= 0 ? 'selected' : '')
									.prop('data', im)
									.click(select);

								var img = $(document.createElement('img'))
									.attr('src', 'thumbnail/' + im['ID']);

								a.append(img);
								a.appendTo(results);
							};

							if(back){
								for(var i=json.length; i--;) render(json[i]);

								last[0] = json[json.length - 1]['ID'];
								last[1] = json[0]['ID'];
							} else {
								for(var i=0; i < json.length; i++) render(json[i]);

								last[0] = json[0]['ID'];
								last[1] = json[json.length - 1]['ID'];
							}

							if(!$('#detailcontainer').is(':visible')){
								$('#resultscontainer').show();
							}
						}
					}
				});
			}
	

			function selectAll()
			{
				var unselected = $('#results a').not('.selected');
				if(unselected.length == 0){
					$('#results a').click();
				} else {
					unselected.click();
				}

				if(selected.length){
					$('#edit-blurb').text(selected.length + ' images selected');
				} else {
					$('#edit-blurb').text('');
				}
			}


			function select()
			{
				$(this).blur();

				if(this.className === 'selected'){
					this.className = '';
					var idx = selected.indexOf(this.data['ID']);
					if(idx >= 0) selected.splice(idx, 1);
				} else {
					this.className = 'selected';
					selected.push(this.data['ID']);
				}

				if(selected.length){
					$('#edit-blurb').text(selected.length + ' images selected');
				} else {
					$('#edit-blurb').text('');
				}

				return false;
			}


			function detail()
			{
				if(selected.length > 0){
					$('#controlcontainer, #resultscontainer').hide();
					$('#detailcontainer').show();

					document.getElementById('taken').focus();
					$.ajax({
						url: 'detail.json', dataType: 'json',
						data: { image_id: selected },
						success: function(json){
							if(json.length){
								console.log(json);
							}
						}
					});
				}
				/*
				map.closePopup();
				if(marker != null){
					map.removeLayer(marker);
					marker = null;
				}
				map.setView([64.843611, -147.723056], 3);

				for(var i in this.data){
					switch(i){
						case 'filename':
							var fn = document.getElementById('filename');
							if(fn != null) fn.innerHTML =
								'<a target="_blank" href="image/' + this.data['ID'] + '">' +
								this.data[i] + '</a>';
						break;

						case 'geoJSON':
							var geojson = JSON.parse(this.data[i]);

							marker = L.marker(
								// I have no idea why this is even necessary.
								// Why are the parameters swapped?
								[geojson.coordinates[1], geojson.coordinates[0]],
								{ keyboard: false, draggable: true }
							).bindPopup(
								'<img src="thumbnail/' + this.data['ID'] + '"/>',
								{
									autoPanPaddingTopLeft: [40, 10],
									autoPanPaddingBottomRight: [55, 10]
								}
							).on('dblclick', function(evt){
								map.removeLayer(marker);
								marker = null;
							}).addTo(map);
						break;

						default:
							var el = document.getElementById(i.toLowerCase());
							if(el != null){
								if(el.tagName == 'INPUT' || el.tagName == 'TEXTAREA'){
									el.value = this.data[i];
								}
							}
						break;
					}
				}
				*/
			}


			function save()
			{
				$('#err').empty();

				var fields = document.querySelectorAll(
					'#detail input, #detail textarea'
				);
				var obj = {};
				for(var i = fields.length; i--;){
					var val = fields[i].value.trim();
					if(val.length > 0) obj[fields[i].id] = val;
				}

				if(marker != null){
					obj['geojson'] = JSON.stringify(
						marker.toGeoJSON()['geometry']
					);
				}

				$('#btn-save').prop('disabled', true).text('Saving.. ');

				$.ajax({
					url: 'image.json', type: 'POST',
					data: obj, dataType: 'json', 
					success: function(json){
						if('success' in json && json['success']){
							$('#btn-save').prop('disabled', false).text('Save Detail');
							// Update saved image object with new data
							var img = $('#img-' + obj.id);
							img.prop('data', $.extend(img.prop('data'), obj));
						}
					},
					error: function(xhr){
						$('#btn-save').prop('disabled', false).text('Save Detail');
						$('#err').text('Error saving: ' + xhr.responseText);
					}
				});
			}


			function remove()
			{
				var msg = "Are you sure you want to delete this photo?\n" +
					"This cannot be undone.";
				if(confirm(msg)){
					var id = $('#id').val();
					$.ajax({
						url: 'image.json', type: 'POST', dataType: 'json',
						data: { 'action': 'delete', 'ID': id },
						success: function(json){
							if('success' in json && json['success']){
								// Hide image on search
								$('#img-' + id).css(
									{ 'opacity': 0.1, 'cursor': 'auto' }
								).unbind('click');
								// Return to search
								$('#btn-return').click();
							}
						}
					});
				}
			}
		</script>
	</head>
	<body load="init()">
		<fieldset id="controlcontainer">
			<legend>Search</legend>
			<button title="Previous Page - Left Arrow" id="btn-prev">Previous Page</button>
			<button title="Next page - Right Arrow" id="btn-next">Next Page</button>

			<div id="search-controls">
				<label for="emptydesc">Description: </label>
				<select name="emptydesc" id="emptydesc">
					<option value="" selected="selected">Any</option>
					<option value="true">Only Empty</option>
					<option value="false">Only Filled</option>
				</select>

				<label for="search">Search: </label>
				<input type="text" size="25" name="search" id="search" />

				<label for="show">Showing: </label>
				<input type="text" size="4" name="show" id="show" value="10" />

				<button id="btn-search">Search</button>
			</div>

			<div id="edit-controls">
				<button id="btn-select">Select All</button>
				<button id="btn-edit" accesskey="e"><u>E</u>dit Selected</button>
				<button id="btn-remove">Remove Selected</button>
				<span id="edit-blurb"></span>
			</div>
		</fieldset>

		<fieldset id="resultscontainer">
			<legend>Results</legend>
			<div id="results"></div>
		</fieldset>

		<fieldset id="detailcontainer">
			<legend>Detail</legend>

			<div id="map"></div>

			<button title="Return to Search - Escape" id="btn-return">Return to Search</button>

			<table id="detail">
				<tbody>
					<tr>
						<th>Filename:</th>
						<td id="filename"></td>
					</tr>
					<tr>
						<th>Date Taken:</th>
						<td>
							<input type="text" name="taken" id="taken" size="9" />
							<input type="checkbox" id="taken-disable" />
						</td>
					</tr>
					<tr>
						<th>Credit:</th>
						<td>
							<textarea name="credit" id="credit" cols="30" rows="2"></textarea>
							<input type="checkbox" id="credit-disable" />
						</td>
					</tr>
					<tr>
						<th>Summary:</th>
						<td>
							<textarea name="summary" id="summary" cols="30" rows="2"></textarea>
							<input type="checkbox" id="summary-disable" />
						</td>
					</tr>
					<tr>
						<th>Description:</th>
						<td>
							<textarea name="description" id="description" cols="35" rows="5"></textarea>
							<input type="checkbox" id="description-disable" />
						</td>
					</tr>
					<tr><td colspan="2">&nbsp;</td></tr>
					<tr>
						<td>&nbsp;</td>
						<td>
							<input type="hidden" name="id" id="id" />

							<button accesskey="d" id="btn-delete"><u>D</u>elete Photo</button>
							<button accesskey="s" id="btn-save"><u>S</u>ave Detail</button>
						</td>
					</tr>
					<tr><td colspan="2" id="err"></td></tr>
				</tbody>
			</table>
		</fieldset>
	</body>
</html>
