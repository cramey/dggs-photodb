<!DOCTYPE html>
<html lang="en">
	<head>
		<meta charset="utf-8">
		<meta http-equiv="x-ua-compatible" content="IE=edge">
		<title>Alaska Division of Geological &amp; Geophysical Surveys Photo Database</title>
		<link rel="stylesheet" href="css/apptmpl.min.css">
		<link rel="stylesheet" href="js/leaflet.css">
		<link rel="stylesheet" href="js/leaflet.mouseposition.css">
		<style>
			#map {
				height: 350px;
				width: 50%;
				min-width: 350px;
				max-width: 550px;
				float: right;
				border: 1px solid #aaa;
				margin: 0 4px 8px 8px;
				visibility: hidden;
			}
			#search-control { margin: 0 4px; }
			#search-field, #search-button {
				box-sizing: content-box;
				vertical-align: middle;
				border-radius: 5px;
				height: 24px;
				border: 1px solid #aaa;
				font-family: Georgia, serif;
				font-size: 14px;
			}
			#search-field {
				padding: 2px;
				width: 375px;
			}
			#search-button { padding: 2px 8px; }
			#search-control {
				text-align: right;
				margin-bottom: 16px;
			}
			#search-results a {
				max-width: 256px;
				display: inline-block;
				font-size: 12px;
				margin: 0 4px 8px 4px;
				text-decoration: none;
			}
			#search-results a:hover {
				text-decoration: underline;
			}
			#search-results img {
				border: none;
			}
		</style>
		<script src="js/mustache-2.3.0.min.js"></script>
		<script src="js/leaflet.js"></script>
		<script src="js/leaflet.mouseposition.js"></script>
		<script>
			var map;
			var baselayers = {
				'Open Street Maps Monochrome': L.tileLayer(
					'http://{s}.tiles.wmflabs.org/bw-mapnik/{z}/{x}/{y}.png',
					{ minZoom: 3, maxZoom: 18, zIndex: 1 }
				),
				'Open Street Maps': new L.TileLayer(
					'//{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',
					{ minZoom: 3, maxZoom: 19, zIndex: 2 }
				),
				'OpenTopoMap': new L.TileLayer(
					'http://{s}.tile.opentopomap.org/{z}/{x}/{y}.png',
					{ minZoom: 3, maxZoom: 17, zIndex: 3  }
				),
				'ESRI Imagery': new L.TileLayer(
					'//server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}',
					{ minZoom: 3, maxZoom: 19, zIndex: 4 }
				),
				'ESRI Topographic': new L.TileLayer(
					'//server.arcgisonline.com/ArcGIS/rest/services/World_Topo_Map/MapServer/tile/{z}/{y}/{x}',
					{ minZoom: 3, maxZoom: 19, zIndex: 5 }
				),
				'ESRI Shaded Relief': new L.TileLayer(
					'//server.arcgisonline.com/ArcGIS/rest/services/World_Shaded_Relief/MapServer/tile/{z}/{y}/{x}',
					{ minZoom: 3, maxZoom: 13, zIndex: 6 }
				),
				'ESRI DeLorme': new L.TileLayer(
					'//server.arcgisonline.com/ArcGIS/rest/services/Specialty/DeLorme_World_Base_Map/MapServer/tile/{z}/{y}/{x}',
					{ minZoom: 3, maxZoom: 11, zIndex: 7 }
				),
				'ESRI National Geographic': new L.TileLayer(
					'//server.arcgisonline.com/ArcGIS/rest/services/NatGeo_World_Map/MapServer/tile/{z}/{y}/{x}',
					{ minZoom: 3, maxZoom: 16, zIndex: 8 }
				),
				'GINA Satellite': new L.TileLayer(
					'http://tiles.gina.alaska.edu/tilesrv/bdl/tile/{x}/{y}/{z}',
					{ minZoom: 3, mazZoom: 15, zIndex: 9 }
				),
				'GINA Topographic': new L.TileLayer(
					'http://tiles.gina.alaska.edu/tilesrv/drg/tile/{x}/{y}/{z}',
					{ minZoom: 3, maxZoom: 12, zIndex: 10 }
				),
				'Stamen Watercolor': new L.TileLayer(
					'http://stamen-tiles-{s}.a.ssl.fastly.net/watercolor/{z}/{x}/{y}.png',
					{ minZoom: 3, maxZoom: 16, subdomains: 'abcd', zIndex: 11 }
				)
			};

			var overlays = {
				'PLSS (BLM)': new L.tileLayer.wms(
					'http://www.geocommunicator.gov/arcgis/services/PLSS/MapServer/WMSServer',
					{
						'layers': '1,2,3,4,5,6,7,8,9,10,11,12,13',
						transparent: true,
						format: 'image/png',
						minZoom: 3, maxZoom: 16, zIndex: 12
					}
				),
				'Quadrangles': new L.TileLayer(
					'http://tiles.gina.alaska.edu/tilesrv/quad_google/tile/{x}/{y}/{z}',
					{ minZoom: 3, maxZoom: 16, zIndex: 13 }
				)
			};

			function init()
			{
				var search_button = document.getElementById('search-button');
				if(search_button) search_button.onclick = search;

				var q = document.getElementById('search-field');
				if(q){
					q.onkeydown = function(evt){
						var e = evt === undefined ? window.event : evt;	
						if(e.keyCode === 13){
							search();
							if('preventDefault' in e) e.preventDefault();
							return false;
						}
					};
					q.focus();
				}

				features = mirroredLayer(null, function(f){
					return {
						color: f.properties.color,
						opacity: 1,
						weight: 2,
						radius: 6,
						fill: false,
						'z-index': 20
					};
				});

				map = L.map('map', {
					closePopupOnClick: false,
					worldCopyJump: true,
					attributionControl: false,
					zoomControl: false,
					minZoom: 3,
					maxZoom: 19,
					center: L.latLng(64.32087, -149.85351),
					zoom: 3,
					layers: [
						baselayers['Open Street Maps'],
						features
					]
				});
				// Add mouse position control
				map.addControl(L.control.mousePosition({
					emptyString: 'Unknown', numDigits: 4
				}));

				// Add scale control
				map.addControl(L.control.scale());

				// Add zoom controls
				map.addControl(L.control.zoom({ position: 'topright' }));

				// Add layer control
				map.addControl(L.control.layers(
					baselayers, overlays, {
						position: 'bottomright', autoZIndex: false
					}
				));
			}

			function search()
			{
				var q = document.getElementById('search-field');
				if(q && q.value.length > 0){
					var params = 'search=' + encodeURIComponent(q.value);
					var xhr = (window.ActiveXObject ? new ActiveXObject('Microsoft.XMLHTTP') : new XMLHttpRequest());
					xhr.onreadystatechange = function(){
						if(xhr.readyState === 4){
							if(xhr.status === 200){
								var obj = JSON.parse(xhr.responseText);
								document.location.hash = '#' + params;

								if('console' in window) console.log(obj);

								features.clearLayers();
								for(var i = 0; i < obj.length; i++){
									var o = obj[i];
									if('geoJSON' in o){
										// Clone the geojson object, allowing
										// the original reference to be freed
										var geojson = {
											type: 'Feature', 
											properties: {
												popup: Mustache.render(
													document.getElementById('tmpl-popup').innerHTML,
													o
												),
												color: '#9f00ff'
											},
											geometry: JSON.parse(JSON.stringify(o['geoJSON']))
										};
										features.addData(geojson);
									}
								}

								map.getContainer().style.visibility = 'visible';

								var map_el = document.getElementById('map');
								if(map_el) map_el.style.display = 'block';

								var results = document.getElementById('search-results');
								var tmpl = document.getElementById('tmpl-search');
								if(results && tmpl){
									results.innerHTML = Mustache.render(
										document.getElementById('tmpl-search').innerHTML,
										obj
									);
								}
							}
						}
					};
					xhr.open('POST', 'list.json', true);
					xhr.setRequestHeader('Content-type', 'application/x-www-form-urlencoded');
					xhr.send(params);
				}
			}

			function mirroredLayer(data, style){
				var layer = L.geoJson(null, {
//					pointToLayer: function (f, ll) {
//						return L.circleMarker(ll);
//					},
					coordsToLatLngInvert: function(c){
						var ll = new L.LatLng(c[1], c[0], c[2]);
						if(ll.lng >= 0) ll.lng -= 360;
						else ll.lng += 360;

						return ll;
					},
					style: style
				});
				layer.on('layeradd', function(e){
					if('coordsToLatLng' in e.target.options){
						delete e.target.options.coordsToLatLng;
					} else {
						e.target.options.coordsToLatLng =
							e.target.options.coordsToLatLngInvert;

						// If the layer has an identifable feature, use that
						// otherwise, just break it down to geoJSON
						if('feature' in e.layer) {
							e.target.addData(e.layer.feature);
						} else {
							e.target.addData(e.layer.toGeoJSON());
						}
					}
				});

				if(data != null) layer.addData(data);
				return layer;
			}
		</script>
	</head>
	<body onload="init()">
		<div class="apptmpl-container">
			<div class="apptmpl-goldbar">
				<a class="apptmpl-goldbar-left" href="http://alaska.gov"></a>
				<span class="apptmpl-goldbar-right"></span>

				<a href="help">Help</a>
			</div>

			<div class="apptmpl-banner">
				<a class="apptmpl-banner-logo" href="http://dggs.alaska.gov"></a>
				<div class="apptmpl-banner-title">Photo Database</div>
				<div class="apptmpl-banner-desc">Alaska Division of Geological &amp; Geophysical Surveys</div>
			</div>

			<div class="apptmpl-breadcrumb">
				<a href="http://alaska.gov">State of Alaska</a> &gt;
				<a href="http://dnr.alaska.gov">Natural Resources</a> &gt;
				<a href="http://dggs.alaska.gov">Geological &amp; Geophysical Surveys</a> &gt;
				<a href=".">Photo Database</a>
			</div>

			<div class="apptmpl-content">
				<div id="search-control">
					<input type="text" id="search-field" name="search-field" placeholder="Search for .. " autocomplete="off">
					<button id="search-button">Search</button>
				</div>
				<div id="map"></div>
				<div id="search-results"></div>
			</div>
		</div>
		<script id="tmpl-search" type="x-tmpl-mustache">
			{{#.}}
				<a href="detail.html#{{ID}}" title="{{filename}}">
					<img src="thumbnail/{{ID}}">
					<div>{{summary}}</div>
					<div>{{credit}} {{taken}}</div>
				</a>
			{{/.}}
		</script>
		<script id="tmpl-popup" type="x-tmpl-mustache">
		</script>
	</body>
</html>
